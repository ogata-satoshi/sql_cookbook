# SQL クックブック

## 前提

SQL クックブックは postgresql などの各ベンダーでの SQL の書き方が記されているが、 BigQuery の書き方は記されていない。
そこで BigQuery ならどのように書けるか実際に試して参考となるクエリを用意した。
また緒方の書いたクエリと同じ結果が返ってくるかどうかテストできるようなプログラムを作成した。

### クエリの実行環境

以下の環境を想定。

- BigQuery

#### クエリが実行されるプロジェクト

Cloud SDK で設定しているプロジェクトに対してクエリが実行される。

#### BigQuery での動作確認済みレシピ

- 2 章
- 3 章
- 6 章
- 7 章
- 8 章
- 9 章
- 10 章
- 11 章
- 12 章
- 13 章
- 14 章

5 章のスキーマ関連のところはそのままだと Bigquery では動かないので注意。
`SMEAGOL.INFORMATION_SCHEMA` のようにデータセットを指定しつつ大文字で記述する必要がある。

### 作成レシピ

簡単な問題はレシピのファイルを作っていない。

逆に複雑すぎる問題で実用性が低そうな問題のレシピも作っていない。例えば総計を表示するようなクエリはもはや使う機会がなさそうなのでほぼ作っていない。

## テスト環境構築

`init` ディレクトリに移動して `sh init.sh` を実行する。
これにより BigQuery 上に問題で使用するテーブルが作成される。

#### 注意点

問題によっては同じ View の名前を使い回すことがあるため問題ごとにその View を作る必要がある。View を作るにはそのレシピの枝番に `-0` をつけたファイルを実行する。

また問題によってはレコードを挿入することがあり、その場合にレコードを削除するファイルを枝番 `-reset` をつけて用意している。残したままでもテストとしては問題ないはずだが本と結果が変わるため本と同じ結果にしたいなら実行する。

## 使い方

### テストのやり方

テストは以下の流れで実施する。

1. （問題によっては）ビューやテーブルの作成
2. 解答作成
3. テスト実行

#### ビューやテーブルの作成

該当する問題番号に `-0` をつけたファイルを実行する。具体的には以下のようなコマンドを実行する。

`sh view.sh [レシピ番号]-0`

レシピが `14.3` であれば以下のコマンドを実行する。

`sh view.sh 14-3-0`

#### 解答の作成

1. `answers` ディレクトリ内のレシピ番号に対応するファイルにクエリを書き込んで保存する。
   1. recipe の中に複数の問題があるときは枝番を１から順につける。
   2. ファイル内のコメントに従ってクエリを書く。従わないとテストに通らないことがある。

#### テストの実行方法

1. コマンドラインで `bash test.sh sqlファイル名` と実行する。
   1. ただし ORDER BY の使い方の演習で順番も含めてテストする場合は第二引数に `order` を追加する。つまり `bash test.sh sqlファイル名 order` を実行する。順番が指定されるのは最初のほうだけ。

#### テスト成功の定義

「テストが成功する」とは以下のクエリで結果が返ってこないことを指す。

```sql
select
  *
from
  (correct_sql) as t1

except

select
  *
from
  (answer_sql) as t2

UNION ALL

select
  *
from
  (answer_sql) as t1

except

select
  *
from
  (correct_sql) as t2
```

第二引数で `order` を指定した場合は以下のクエリで結果が返ってこないことを指す。

```sql
select
  *, row_number() over ()
from
  (correct_sql) as t1

except

select
  *, row_number() over ()
from
  (answer_sql) as t2

  UNION ALL

select
  *, row_number() over ()
from
  (answer_sql) as t1

except

select
  *, row_number() over ()
from
  (correct_sql) as t2
```
